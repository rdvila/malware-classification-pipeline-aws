import json
def get_workflow():

    ############################### Scheduler ###############################
    start_scheduler_task={
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:runTask",
        "Parameters":{
            "Cluster": "${cluster}",
            "Count": 1,
            "NetworkConfiguration": {
                "AwsvpcConfiguration": {
                    "Subnets": ["${subnet1}", "${subnet2}"],
                    "SecurityGroups": ["${securitygroup}"],
                    "AssignPublicIp": "ENABLED"
                }
            },
            "Overrides": {
                "ContainerOverrides": [
                    {
                        "Name": "dask",
                        "Command": ["dask-scheduler","--port","8000","--dashboard-address","8001"]}
                ]
            },
            "TaskDefinition": "${taskdefinition}"
        },
        "ResultSelector":{
          "SchedulerArn.$": "$.Tasks[0].TaskArn",
          "DesiredStatus": {
              "Value.$": "$.Tasks[0].DesiredStatus"
          }
        },
        "ResultPath": "$.Scheduler"
    }
    
    stop_scheduler_task = {
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:stopTask",
        "InputPath": "$.Scheduler",
        "Parameters":{
            "Cluster": "${cluster}",
            "Task.$": "$.SchedulerArn",
            "Reason": "Stoped by stepfunction"
        },
        "ResultSelector": {
          "Value.$": "$.Task.DesiredStatus"
        },
        "ResultPath": "$.Scheduler.DesiredStatus"
    }
    
    get_scheduler_status={
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:describeTasks",
        "InputPath": "$.Scheduler",
        "Parameters":{
            "Cluster": "${cluster}",
            "Tasks.$": "States.Array($.SchedulerArn)"
        },
        "ResultSelector": {
          "Value.$": "$.Tasks[0].LastStatus"
        },
        "ResultPath": "$.Scheduler.Status"
    }
    
    wait_10_seconds = {
        "Type": "Wait",
        "Seconds": 10,
    }
    
    is_scheduler_running={
        "Variable": "$.Scheduler.Status.Value",
        "StringEquals": "RUNNING"
    }
    
    is_scheduler_stoped={
        "Variable": "$.Scheduler.Status.Value",
        "StringEquals": "STOPPED"
    }
    
    get_scheduler_endpoint={
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:describeTasks",
        "InputPath": "$.Scheduler",
        "Parameters":{
            "Cluster": "${cluster}",
            "Tasks.$": "States.Array($.SchedulerArn)"
        },
        "ResultSelector": {
          "Value.$": "States.Format('tcp://{}:8000', $.Tasks[0].Containers[0].NetworkInterfaces[0].PrivateIpv4Address)"
        },
        "ResultPath": "$.Scheduler.Endpoint"   
    }
    ############################### Scheduler ###############################
    
    wait_30_seconds = {
        "Type": "Wait",
        "Seconds": 30,
    }
    
    ############################### Workers ###############################
    start_workers_tasks={
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:runTask",
        "Parameters":{
            "Cluster": "${cluster}",
            "Count.$": "$.WorkersCount",
            "NetworkConfiguration": {
                "AwsvpcConfiguration": {
                    "Subnets": ["${subnet1}", "${subnet2}"],
                    "SecurityGroups": ["${securitygroup}"],
                    "AssignPublicIp": "ENABLED"
                }
            },
            "Overrides": {
                "ContainerOverrides": [
                    {
                        "Name": "dask",
                        "Command.$": "States.Array('dask-worker', '--dashboard-address', '8000', '--nanny-port', '8001:8100', '--worker-port', '8100:8200', $.Scheduler.Endpoint.Value)"
                    }
                ]
            },
            "TaskDefinition": "${taskdefinition}"
        },
        "ResultSelector":{
          "WorkersArn.$": "$.Tasks[*].TaskArn",
          "Status": {
             "Value.$": "$.Tasks[*].LastStatus",
          },
          "DesiredStatus": {
              "Value.$": "$.Tasks[*].DesiredStatus"
          }
        },
        "ResultPath": "$.Workers"
    }
    
    get_worker_status={
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:describeTasks",
        "Parameters":{
            "Cluster": "${cluster}",
            "Tasks.$": "States.Array($.TaskArn)"
        },
        "ResultSelector": {
          "Value.$": "$.Tasks[0].LastStatus"
        },
        "ResultPath": "$.Status"
    }
    
    is_worker_running={
        "Variable": "$.Status.Value",
        "StringEquals": "RUNNING"
    }
    
    validate_workers={
          "Type": "Map",
          "InputPath": "$.Workers",
          "ItemsPath": "$.WorkersArn",
          "MaxConcurrency": 1,
          "Parameters": {
            "TaskArn.$": "$$.Map.Item.Value",
            "Cluster": "${cluster}"
          },
          "Iterator": {
              "StartAt": "get worker status",
              "States": {
                  "get worker status": {
                      **get_worker_status,
                      "Next": "is worker running"
                  },
                  "is worker running": {
                    "Type": "Choice",
                    "Default": "wait 10 seconds to get worker running status",
                    "Choices": [
                        {
                            **is_worker_running,
                            "Next": "worker is running"
                        }
                    ]
                    
                },
                "wait 10 seconds to get worker running status": {
                    **wait_10_seconds,
                    "Next": "get worker status"
                },
                "worker is running": {
                    "Type": "Pass",
                    "End": True
                }
              }
          },
          "ResultSelector": {
              "Value.$": "$[*].Status.Value"
           },
          "ResultPath": "$.Workers.Status"
          
    }
    
    stop_worker = {
        "Type": "Task",
        "Resource": "arn:aws:states:::aws-sdk:ecs:stopTask",
        "Parameters":{
            "Cluster": "${cluster}",
            "Task.$": "$.TaskArn",
            "Reason": "Stoped by stepfunction"
        },
        "ResultSelector": {
          "Value.$": "$.Task.DesiredStatus"
        },
        "ResultPath": "$.DesiredStatus"
    }
    
    stop_workers_tasks={
          "Type": "Map",
          "InputPath": "$.Workers",
          "ItemsPath": "$.WorkersArn",
          "MaxConcurrency": 1,
          "Parameters": {
            "TaskArn.$": "$$.Map.Item.Value",
            "Cluster": "${cluster}"
          },
          "Iterator": {
              "StartAt": "stop worker",
              "States": {
                  "stop worker": {
                     **stop_worker,
                     "End": True
                  }
              }
          },
          "ResultSelector": {
              "Value.$": "$[*].DesiredStatus.Value"
           },
          "ResultPath": "$.Workers.DesiredStatus"
          
    }
    
    is_worker_stopped={
        "Variable": "$.Status.Value",
        "StringEquals": "STOPPED"
    }
    
    validate_stopped_workers={
          "Type": "Map",
          "InputPath": "$.Workers",
          "ItemsPath": "$.WorkersArn",
          "MaxConcurrency": 1,
          "Parameters": {
            "TaskArn.$": "$$.Map.Item.Value",
            "Cluster": "${cluster}"
          },
          "Iterator": {
              "StartAt": "get worker stopped status",
              "States": {
                  "get worker stopped status": {
                      **get_worker_status,
                      "Next": "is worker stopped"
                  },
                  "is worker stopped": {
                    "Type": "Choice",
                    "Default": "wait 10 seconds to get worker stopped status",
                    "Choices": [
                        {
                            **is_worker_stopped,
                            "Next": "worker is stopped"
                        }
                    ]
                    
                },
                "wait 10 seconds to get worker stopped status": {
                    **wait_10_seconds,
                    "Next": "get worker stopped status"
                },
                "worker is stopped": {
                    "Type": "Pass",
                    "End": True
                }
              }
          },
          "ResultSelector": {
              "Value.$": "$[*].Status.Value"
           },
          "ResultPath": "$.Workers.Status"
          
    }
    
    ############################### Workers ###############################
    
    ############################### Definition ###############################
    workflowdefinition={
        "StartAt": "validate parameters",
        "States": {
            "validate parameters": {
              "Type": "Choice",
              "Default": "parameter validation failed",
              "Choices": [
                {
                    "And": [
                        {
                          "Variable": "$.WorkersCount",
                          "IsPresent": True
                        },
                        {
                          "Variable": "$.WorkersCount",
                          "IsNumeric": True
                        },
                        {
                          "Variable": "$.WorkersCount",
                          "NumericGreaterThan": 0
                        },
                        {
                          "Variable": "$.WorkersCount",
                          "NumericLessThanEquals": 10
                        },
                        {
                          "Variable": "$.SkipScheduler",
                          "IsPresent": True
                        },
                        {
                          "Variable": "$.SkipScheduler",
                          "IsBoolean": True
                        },
                        {
                          "Variable": "$.SkipWorkers",
                          "IsPresent": True
                        },
                        {
                          "Variable": "$.SkipWorkers",
                          "IsBoolean": True
                        },
                        {
                          "Variable": "$.SkipWorkersStop",
                          "IsPresent": True
                        },
                        {
                          "Variable": "$.SkipWorkersStop",
                          "IsBoolean": True
                        },
                        {
                          "Variable": "$.SkipSchedulerStop",
                          "IsPresent": True
                        },
                        {
                          "Variable": "$.SkipSchedulerStop",
                          "IsBoolean": True
                        }
                    ],
                  "Next": "skip scheduler?"
                }
              ]
            },
            "parameter validation failed": {
               "Type": "Fail",
               "Cause": "Invalid Parameters",
               "Error": "INVALID_PARAMETERS"
            },
            "skip scheduler?": {
                "Type": "Choice",
                "Default": "start scheduler task",
                "Choices": [
                    {
                        "Variable": "$.SkipScheduler",
                        "BooleanEquals": True,
                        "Next": "skip workers?"
                    }
                ]
                
            },
            "start scheduler task":{ 
                **start_scheduler_task,
                "Next": "get scheduler running status"
            },
            "get scheduler running status": {
                **get_scheduler_status,
                "Next": "is scheduler running"
            },
            "wait 10 seconds to get scheduler running status": {
                **wait_10_seconds,
                "Next": "get scheduler running status"
            },
            "is scheduler running": {
                "Type": "Choice",
                "Default": "wait 10 seconds to get scheduler running status",
                "Choices": [
                    {
                        **is_scheduler_running,
                        "Next": "get scheduler endpoint"
                    }
                ]
                
            },
            "get scheduler endpoint": {
                **get_scheduler_endpoint,
                "Next": "skip workers?"
            },
            "skip workers?": {
                "Type": "Choice",
                "Default": "start workers tasks",
                "Choices": [
                    {
                        "Variable": "$.SkipWorkers",
                        "BooleanEquals": True,
                        "Next": "wait 30 seconds"
                    }
                ]
                
            },
            "start workers tasks": {
                **start_workers_tasks,
                "Next": "validate workers"
            },
            "validate workers": {
                **validate_workers,
                "Next": "wait 30 seconds"
            },
            "wait 30 seconds": {
                **wait_30_seconds,
                "Next": "skip workers stop?"
            },
             "skip workers stop?": {
                "Type": "Choice",
                "Default": "stop workers tasks",
                "Choices": [
                    {
                        "Variable": "$.SkipWorkersStop",
                        "BooleanEquals": True,
                        "Next": "skip scheduler stop?"
                    }
                ]
                
            },
            "stop workers tasks": {
                **stop_workers_tasks,
                "Next": "validate stopped workers"
            },
            "validate stopped workers": {
                **validate_stopped_workers,
                "Next": "skip scheduler stop?"
            },
            "skip scheduler stop?": {
                "Type": "Choice",
                "Default": "stop scheduler task",
                "Choices": [
                    {
                        "Variable": "$.SkipSchedulerStop",
                        "BooleanEquals": True,
                        "Next": "success"
                    }
                ]
                
            },
            "stop scheduler task": {
                **stop_scheduler_task,
                "Next": "get scheduler stop status"
            },
            "get scheduler stop status": {
                **get_scheduler_status,
                "Next": "is scheduler stoped"
            },
            "is scheduler stoped": {
                "Type": "Choice",
                "Default": "wait 10 seconds to get scheduler stop status",
                "Choices": [
                    {
                        **is_scheduler_stoped,
                        "Next": "success"
                    }
                ]
                
            },
            "wait 10 seconds to get scheduler stop status": {
                **wait_10_seconds,
                "Next": "get scheduler stop status"
            },
            "success": {
                "Type": "Succeed"
            }
        }
    }
    ############################### Definition ###############################
    
    return json.dumps(workflowdefinition)

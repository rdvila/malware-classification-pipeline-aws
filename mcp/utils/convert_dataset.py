import numpy as np
import lmdb
import msgpack
import zlib
import sqlite3
import pandas as pd
from joblib import Parallel, delayed

MAX_THREADS = 4
MAX_RECORDS_PER_FILE = 25000


def features_postproc_func(x):
    x = np.asarray(x[0], dtype=np.float32)
    return x


def create_csv(file, offset, rows):
    df = pd.DataFrame(rows, columns=['sha', 'class', 'adware', 'flooder',
                                     'ransonware', 'dropper', 'spyware',
                                     'packed', 'crypto_miner',
                                     'file_infector', 'installer',
                                     'worm', 'downloader'] +
                                    [f'feature_{x}' for x in range(2381)])
    rows.clear()
    print(f'Creating csv file for file {file} offset {offset}....')
    df.to_csv(f'sorel_{file:04d}_p{offset:03d}.csv.gz',
              index=False, header=True, compression='gzip')


def convert_dataset(mod, offset):
    lmdb_file = "ember_features"
    lmdb_env = lmdb.open(lmdb_file)
    lmdb_txn = lmdb_env.begin()
    lmdb_cursor = lmdb_txn.cursor()

    sqlite_conn = sqlite3.connect('meta.db')
    query = "select * from meta where sha256 = '%s'"
    sqlite_cur = sqlite_conn.cursor()

    index = 0
    file = 0
    rows = []
    print('started......')
    for key, value in lmdb_cursor:
        index += 1
        if index % mod != offset:
            continue
        features = features_postproc_func(msgpack.loads(
            zlib.decompress(value), strict_map_key=False))

        val = sqlite_cur.execute(query % key.decode('utf-8')).fetchone()
        if val is None:
            continue

        sha, is_malware, _, _, adware,\
            flooder, ransonware, dropper,\
            spyware, packed, crypto_miner,\
            file_infector, installer, worm,\
            downloader = val

        if int(is_malware) == 0:
            continue

        tags = [int(adware > 0),
                int(flooder > 0),
                int(ransonware > 0),
                int(dropper > 0),
                int(spyware > 0),
                int(packed > 0),
                int(crypto_miner > 0),
                int(file_infector > 0),
                int(installer > 0),
                int(worm > 0),
                int(downloader > 0)]

        class_ = int("".join(str(x) for x in tags), 2)

        if class_ == 0:
            continue

        rows.append([sha, class_] + tags + list(features))
        if len(rows) >= MAX_RECORDS_PER_FILE:
            create_csv(file, offset, rows)
            file += 1

    create_csv(file, offset, rows)
    sqlite_conn.close()
    print('finished......')


if __name__ == '__main__':
    number_of_cpu = MAX_THREADS
    delayed_funcs = [delayed(convert_dataset)(
        number_of_cpu, x) for x in range(number_of_cpu)]

    parallel_pool = Parallel(n_jobs=number_of_cpu)
    parallel_pool(delayed_funcs)

from troposphere import (
    GetAtt,
    GetAZs,
    Join,
    Output,
    Parameter,
    Ref,
    Select,
    Tags,
    Template,
)

from troposphere.ecs import (
    Cluster,
    ContainerDefinition,
    NetworkConfiguration,
    PortMapping,
    RuntimePlatform,
    TaskDefinition,
    CapacityProviderStrategyItem,
    HealthCheck,
    Ulimit,
    EphemeralStorage,
    LogConfiguration
)
from troposphere.iam import (
    PolicyType,
    Role
)
from troposphere.ec2 import (
    SecurityGroup,
    SecurityGroupIngress
)

t = Template()
t.set_version("2010-09-09")

region = Ref("AWS::Region")

clustersecuritygroup=t.add_resource(
    SecurityGroup(
        "ClusterSecurityGroup",
        GroupDescription="Cluster default security group",
        Tags=Tags(CreatedBy='malware-classification-pipeline'),
    )
)

clustersecuritygroupingress=t.add_resource(
    SecurityGroupIngress(
        "ClusterSecurityGroupIngress",
        GroupName=Ref(clustersecuritygroup),
        SourceSecurityGroupName=Ref(clustersecuritygroup),
        IpProtocol="tcp",
        FromPort=8000,
        ToPort=8001,
        DependsOn="ClusterSecurityGroup",
    )
)


cluster=t.add_resource(
    Cluster(
        "MalwareClassificationCluster",
        ClusterName="malware_classification_cluster",
        CapacityProviders=["FARGATE", "FARGATE_SPOT"],
        DefaultCapacityProviderStrategy=[
            CapacityProviderStrategyItem(
                Base=2,
                CapacityProvider="FARGATE",
                Weight=1
            ),
            CapacityProviderStrategyItem(
                Base=0,
                CapacityProvider="FARGATE_SPOT",
                Weight=3
            )
        ],
        Tags=Tags(CreatedBy='malware-classification-pipeline'),
    )
)

daskexecutionrole=t.add_resource(
    Role(
        "DaskExecutionRole",
        AssumeRolePolicyDocument={
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": "sts:AssumeRole",
                    "Principal": {"Service": ["ecs-tasks.amazonaws.com"]},
                    "Effect": "Allow",
                }
            ],
        },
        Path="/"
    )
)

dasktaskrole=t.add_resource(
    Role(
        "DaskTaskRole",
        AssumeRolePolicyDocument={
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": "sts:AssumeRole",
                    "Principal": {"Service": ["ecs.amazonaws.com", "states.amazonaws.com"]},
                    "Effect": "Allow",
                },
            ],
        },
        Path="/"
    )
)

daskexecutionpolicy=t.add_resource(
    PolicyType(
        "DaskExecutionPolicy",
        PolicyName="DaskExecutionPolicy",
        PolicyDocument={
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": [
                        "ecr:GetAuthorizationToken",
                        "ecr:BatchCheckLayerAvailability",
                        "ecr:GetDownloadUrlForLayer",
                        "ecr:BatchGetImage"
                    ],
                    "Resource": ["*"],
                    "Effect": "Allow",
                    "Sid": "AllowPull",
                },
                {
                    "Action": [
                        "logs:CreateLogGroup",
                        "logs:CreateLogStream",
                        "logs:PutLogEvents"
                    ],
                    "Resource": ["*"],
                    "Effect": "Allow",
                    "Sid": "AllowLogs",
                },
            ],
        },
        Roles=[Ref("DaskExecutionRole")],
    )
)

schedulertaskdefinition=t.add_resource(
    TaskDefinition(
        "DaskTaskDefinition",
        RequiresCompatibilities=["FARGATE"],
        RuntimePlatform=RuntimePlatform(
            CpuArchitecture="X86_64",
            OperatingSystemFamily="LINUX",
        ),
        Cpu="2048",
        Memory="4096",
        EphemeralStorage=EphemeralStorage(SizeInGiB=60),
        NetworkMode="awsvpc",
        Family="dask-family",
        ExecutionRoleArn=GetAtt(daskexecutionrole, "Arn"),
        TaskRoleArn=GetAtt(dasktaskrole, "Arn"),
        ContainerDefinitions=[
            ContainerDefinition(
                Name="dask", 
                Essential=True,
                HealthCheck=HealthCheck(
                    Command=[ "CMD-SHELL", "pidof tini || exit 1" ],
                    Interval=15,
                    Retries=10,
                    StartPeriod=30,
                    Timeout=10,
                ),
                Image=Join(".", [Ref("AWS::AccountId"),"dkr","ecr",Ref("AWS::Region"),"amazonaws","com/malware-classification-repository:latest"]),
                PortMappings=[
                    PortMapping(ContainerPort=8000, HostPort=8000, Protocol="tcp"),
                    PortMapping(ContainerPort=8001, HostPort=8001, Protocol="tcp"),
                ],
                Ulimits=[
                    Ulimit(HardLimit=102400, SoftLimit=102400, Name="nofile")
                ],
                LogConfiguration=LogConfiguration(
                    LogDriver="awslogs",
                    Options={
                        "awslogs-group": "malware-classification-pipeline-cluster",
                        "awslogs-region": Ref("AWS::Region"),
                        "awslogs-create-group": "true",
                        "awslogs-stream-prefix": "dask-"
                    }
                )
            )
        ],
        Tags=Tags(CreatedBy='malware-classification-pipeline'),
    )
)

with open('cluster.yml', 'w') as f:
    f.write(t.to_yaml())



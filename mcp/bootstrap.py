from troposphere import Tags, Tag, Template
from troposphere.s3 import (
    Bucket,
    NotificationConfiguration,
    EventBridgeConfiguration,
    LifecycleConfiguration,
    LifecycleRule,
    LifecycleRuleTransition,
)

from troposphere.ecr import Repository

t = Template()
t.set_version("2010-09-09")

bucket = t.add_resource(
    Bucket(
        'DataScienceBucket',
        NotificationConfiguration=NotificationConfiguration(
            EventBridgeConfiguration=EventBridgeConfiguration(
                EventBridgeEnabled=True
            )
        ),
        LifecycleConfiguration=LifecycleConfiguration(
            Rules=[
                LifecycleRule(
                    Id='DataRule',
                    Prefix='data',
                    Status='Enabled',
                    Transitions=[
                        LifecycleRuleTransition(
                            TransitionInDays=180,
                            StorageClass='STANDARD_IA'
                        )
                    ]
                ),
                LifecycleRule(
                    Id='MetadataRule',
                    Prefix='tmp',
                    Status='Enabled',
                    ExpirationInDays=7
                )
            ]
        ),
        DeletionPolicy='Retain',
        UpdateReplacePolicy='Retain',
        Tags=Tags(Name="Bucket - Data Science", CreatedBy='data-science-pipeline'),
    )
)

repository = t.add_resource(
    Repository(
        "DataSciencePreprocessing",
        RepositoryName="data-science-preprocessing",
        Tags=Tags(Name="ECR - Data Science Preprocessing", CreatedBy='data-science-pipeline')
    )
)

repository = t.add_resource(
    Repository(
        "DataScienceTraining",
        RepositoryName="data-science-training",
        Tags=Tags(Name="ECR - Data Science Training", CreatedBy='data-science-pipeline'),
    )
)

repository = t.add_resource(
    Repository(
        "DataScienceHyperparameterTuning",
        RepositoryName="data-science-hyperparameter-tuning",
        Tags=Tags(Name="ECR - Data Science Hyperparameter Tuning", CreatedBy='data-science-pipeline')
    )
)

repository = t.add_resource(
    Repository(
        "DataScienceTest",
        RepositoryName="data-science-test",
        Tags=Tags(Name="ECR - Data Science Test", CreatedBy='data-science-pipeline')
    )
)

repository = t.add_resource(
    Repository(
        "DataScienceInference",
        RepositoryName="data-science-inference",
        Tags=Tags(Name="ECR - Data Science Inference", CreatedBy='data-science-pipeline')
    )
)

with open('bootstrap.yml', 'w') as f:
    f.write(t.to_yaml())

from troposphere import Tags, Tag, Template
from troposphere.s3 import (
    Bucket,
    NotificationConfiguration,
    EventBridgeConfiguration,
    LifecycleConfiguration,
    LifecycleRule,
    LifecycleRuleTransition,
)

from troposphere.ecr import Repository

t = Template()
t.set_version("2010-09-09")

bucket = t.add_resource(
    Bucket(
        'MalwareClassificationBucket',
        NotificationConfiguration=NotificationConfiguration(
            EventBridgeConfiguration=EventBridgeConfiguration(
                EventBridgeEnabled=True
            )
        ),
        LifecycleConfiguration=LifecycleConfiguration(
            Rules=[
                LifecycleRule(
                    Id='MetadataRule',
                    Prefix='metadata',
                    Status='Enabled',
                    Transitions=[
                        LifecycleRuleTransition(
                            TransitionInDays=180,
                            StorageClass='STANDARD_IA'
                        )
                    ]
                )
            ]
        ),
        DeletionPolicy='Retain',
        UpdateReplacePolicy='Retain',
        Tags=Tags(Name="Bucket - Malware Classification", CreatedBy='malware-classification-pipeline'),
    )
)

repository = t.add_resource(
    Repository(
        "MalwareClassificationEcrRepository",
        RepositoryName="malware-classification-repository",
    )
)

with open('bootstrap.yml', 'w') as f:
    f.write(t.to_yaml())

import json

from troposphere.stepfunctions import StateMachine

from troposphere import (
    GetAtt,
    GetAZs,
    Join,
    Output,
    Parameter,
    Ref,
    Select,
    Tags,
    Template,
)

from troposphere.iam import (
    Policy,
    Role
)

workflowdefinition = {
    "StartAt": "skip preprocessing?",
    "States": {
        "skip preprocessing?": {
            "Type": "Choice",
            "Default": "skip hyperparameter tuning?",
            "Choices": [
              {
                  "Variable": "$.Experiment.Preprocessing",
                  "IsPresent": True,
                  "Next": "start preprocessing"
              }
            ]
        },
        "skip hyperparameter tuning?": {
            "Type": "Choice",
            "Default": "skip training?",
            "Choices": [
                {
                    "Variable": "$.Experiment.HyperparameterTuning",
                    "IsPresent": True,
                    "Next": "start hyperparameter tuning"
                }
            ]
        },
        "skip training?": {
            "Type": "Choice",
            "Default": "skip test?",
            "Choices": [
                {
                    "Variable": "$.Experiment.Training",
                    "IsPresent": True,
                    "Next": "start training"
                }
            ]
        },
        "skip test?": {
            "Type": "Choice",
            "Default": "skip deployment?",
            "Choices": [
                {
                    "Variable": "$.Experiment.Test",
                    "IsPresent": True,
                    "Next": "start test"
                }
            ]
        },
        "skip deployment?": {
            "Type": "Choice",
            "Default": "success",
            "Choices": [
                {
                    "Variable": "$.Experiment.Deployment",
                    "IsPresent": True,
                    "Next": "start deployment"
                }
            ]
        },
        "start preprocessing": {
            "Type": "Map",
            "ItemsPath": "$.Experiment.Preprocessing",
            "MaxConcurrency": 1,
            "Parameters": {
                "ExperimentId.$": "$.Experiment.Name",
                "Jobs.$": "$$.Map.Item.Value"
            },
            "Iterator": {
                "StartAt": "preprocessing",
                "States": {
                    "preprocessing": {
                        "Type": "Map",
                        "ItemsPath": "$.Jobs",
                        "MaxConcurrency": 3,
                        "Parameters": {
                            "AccountId": "${AccountId}",
                            "Region": "${Region}",
                            "RoleArn": "${RoleArn}",
                            "ExperimentId.$": "$.ExperimentId",
                            "ExperimentName.$": "$$.Map.Item.Value.Name",
                            "Image.$": "$$.Map.Item.Value.Image",
                            "InstanceCount.$": "$$.Map.Item.Value.InstanceCount",
                            "InstanceType.$": "$$.Map.Item.Value.InstanceType",
                            "VolumeSizeInGB.$": "$$.Map.Item.Value.VolumeSizeInGB",
                            "Bucket.$": "$$.Map.Item.Value.Bucket",
                            "InputPrefix.$": "$$.Map.Item.Value.InputPrefix",
                            "OutputPrefix.$": "$$.Map.Item.Value.OutputPrefix",
                            "ContainerArguments.$": "$$.Map.Item.Value.ScriptArguments",
                            "MaxRuntimeInSeconds.$": "$$.Map.Item.Value.MaxRuntimeInSeconds",
                            "ExecutionName.$": "$$.Execution.Name",
                            "Script.$": "$$.Map.Item.Value.Script"
                        },
                        "Iterator": {
                            "StartAt": "preprocessing job",
                            "States": {
                                "preprocessing job": {
                                    "Type": "Task",
                                    "Resource": "arn:aws:states:::sagemaker:createProcessingJob.sync",
                                    "Parameters": {
                                        "AppSpecification": {
                                            "ImageUri.$": "States.Format('{}.dkr.ecr.{}.amazonaws.com/{}', $.AccountId, $.Region, $.Image)",
                                            "ContainerArguments.$": "$.ContainerArguments",
                                            "ContainerEntrypoint.$": "States.Array('python', $.Script)"
                                        },
                                        "ProcessingResources": {
                                            "ClusterConfig": {
                                                "InstanceCount.$": "$.InstanceCount",
                                                "InstanceType.$": "$.InstanceType",
                                                "VolumeSizeInGB.$": "$.VolumeSizeInGB"
                                            }
                                        },
                                        "RoleArn.$": "$.RoleArn",
                                        "ProcessingInputs": [
                                            {
                                                "InputName": "input",
                                                "S3Input": {
                                                    "LocalPath": "/opt/ml/processing/data/",
                                                    "S3CompressionType": "None",
                                                    "S3DataType": "S3Prefix",
                                                    "S3InputMode": "File",
                                                    "S3DataDistributionType": "FullyReplicated",
                                                    "S3Uri.$": "States.Format('s3://{}/{}', $.Bucket, $.InputPrefix)"
                                                }
                                            }
                                        ],
                                        "ProcessingJobName.$": "States.Format('{}-{}-{}', $.ExecutionName, $.ExperimentId, $.ExperimentName)",
                                        "ProcessingOutputConfig": {
                                            "Outputs": [
                                                {
                                                    "OutputName": "output",
                                                    "S3Output": {
                                                        "LocalPath": "/opt/ml/processing/output/",
                                                        "S3UploadMode": "EndOfJob",
                                                        "S3Uri.$": "States.Format('s3://{}/{}', $.Bucket, $.OutputPrefix)"
                                                    }
                                                }
                                            ]
                                        },
                                        "StoppingCondition": {
                                            "MaxRuntimeInSeconds.$": "$.MaxRuntimeInSeconds"
                                        }
                                    },
                                    "End": True
                                }
                            }
                        },
                        "End": True,
                    },
                }
            },
            "ResultSelector": {
                "Status": "OK"
            },
            "ResultPath": "$.PreprocessingExecution",
            "Next": "skip hyperparameter tuning?"
        },
        "start hyperparameter tuning": {
            "Type": "Map",
            "ItemsPath": "$.Experiment.HyperparameterTuning",
            "MaxConcurrency": 1,
            "Parameters": {
                "AccountId": "${AccountId}",
                "Region": "${Region}",
                "RoleArn": "${RoleArn}",
                "ExperimentId.$": "$.Experiment.Name",
                "ExperimentName.$": "$$.Map.Item.Value.Name",
                "Image.$": "$$.Map.Item.Value.Image",
                "InstanceCount.$": "$$.Map.Item.Value.InstanceCount",
                "InstanceType.$": "$$.Map.Item.Value.InstanceType",
                "VolumeSizeInGB.$": "$$.Map.Item.Value.VolumeSizeInGB",
                "Bucket.$": "$$.Map.Item.Value.Bucket",
                "InputPrefix.$": "$$.Map.Item.Value.InputPrefix",
                "OutputPrefix.$": "$$.Map.Item.Value.OutputPrefix",
                "MaxRuntimeInSeconds.$": "$$.Map.Item.Value.MaxRuntimeInSeconds",
                "ExecutionName.$": "$$.Execution.Name",
                "MetricDefinitions.$": "$$.Map.Item.Value.MetricDefinitions",
                "TuningObjective.$": "$$.Map.Item.Value.TuningObjective",
                "Strategy.$": "$$.Map.Item.Value.Strategy",
                "MaxNumberOfTrainingJobs.$": "$$.Map.Item.Value.MaxNumberOfTrainingJobs",
                "MaxParallelTrainingJobs.$": "$$.Map.Item.Value.MaxParallelTrainingJobs",
                "TrainingJobEarlyStoppingType.$": "$$.Map.Item.Value.TrainingJobEarlyStoppingType",
                "TargetObjectiveMetricValue.$": "$$.Map.Item.Value.TargetObjectiveMetricValue",
                "HyperParameterRanges.$": "$$.Map.Item.Value.HyperParameterRanges"
                                
            },
            "Iterator": {
                "StartAt": "tuning",
                "States": {
                    "tuning": {
                        "Type": "Task",
                        "Resource": "arn:aws:states:::sagemaker:createHyperParameterTuningJob.sync",
                        "Parameters": {
                            "HyperParameterTuningJobConfig": {
                                "ResourceLimits": { 
                                     "MaxNumberOfTrainingJobs.$": "$.MaxNumberOfTrainingJobs",
                                     "MaxParallelTrainingJobs.$": "$.MaxParallelTrainingJobs"
                                },
                                "Strategy.$": "$.Strategy",
                                "TrainingJobEarlyStoppingType.$": "$.TrainingJobEarlyStoppingType",
                                "TuningJobCompletionCriteria": { 
                                    "TargetObjectiveMetricValue.$": "$.TargetObjectiveMetricValue"
                                },
                                "HyperParameterTuningJobObjective.$": "$.TuningObjective",
                                "ParameterRanges.$": "$.HyperParameterRanges",
                            },
                            "HyperParameterTuningJobName.$": "States.Format('{}-{}-{}', $.ExecutionName, $.ExperimentId, $.ExperimentName)",
                            "TrainingJobDefinition": {
                                "AlgorithmSpecification": {
                                    "TrainingImage.$": "States.Format('{}.dkr.ecr.{}.amazonaws.com/{}', $.AccountId, $.Region, $.Image)",
                                    "TrainingInputMode": "File",
                                    "MetricDefinitions.$": "$.MetricDefinitions"
                                },
                                "CheckpointConfig": {
                                    "LocalPath": "/opt/ml/checkpoints/",
                                    "S3Uri.$": "States.Format('s3://{}/{}/', $.Bucket, $.ExperimentName)"
                                },
                                "InputDataConfig": [
                                    {
                                        "ChannelName": "training",
                                        "DataSource": {
                                            "S3DataSource": {
                                                "S3DataDistributionType": "FullyReplicated",
                                                "S3DataType": "S3Prefix",
                                                "S3Uri.$": "States.Format('s3://{}/{}', $.Bucket, $.InputPrefix)"
                                            }
                                        },
                                        "InputMode": "File"
                                    },
                                ],
                                "OutputDataConfig": {
                                    "S3OutputPath.$": "States.Format('s3://{}/{}', $.Bucket, $.OutputPrefix)"
                                },
                                "ResourceConfig": {
                                    "InstanceCount.$": "$.InstanceCount",
                                    "InstanceType.$": "$.InstanceType",
                                    "VolumeSizeInGB.$": "$.VolumeSizeInGB"
                                },
                                "RetryStrategy": {
                                    "MaximumRetryAttempts": 1
                                },
                                "RoleArn.$": "$.RoleArn",
                                "StoppingCondition": {
                                    "MaxRuntimeInSeconds.$": "$.MaxRuntimeInSeconds",
                                }
                            }

                        },
                        "End": True
                    }

                }
            },
            "ResultSelector": {
                "Status": "OK"
            },
            "ResultPath": "$.HyperparameterTuningExecution",
            "Next": "skip training?"
        },
       "start training": {
            "Type": "Map",
            "ItemsPath": "$.Experiment.Training",
            "MaxConcurrency": 1,
            "Parameters": {
                "ExperimentId.$": "$.Experiment.Name",
                "Jobs.$": "$$.Map.Item.Value"
            },
            "Iterator": {
                "StartAt": "training",
                "States": {
                    "training": {
                        "Type": "Map",
                        "ItemsPath": "$.Jobs",
                        "MaxConcurrency": 3,
                        "Parameters": {
                            "AccountId": "${AccountId}",
                            "Region": "${Region}",
                            "RoleArn": "${RoleArn}",
                            "ExperimentId.$": "$.ExperimentId",
                            "ExperimentName.$": "$$.Map.Item.Value.Name",
                            "Image.$": "$$.Map.Item.Value.Image",
                            "InstanceCount.$": "$$.Map.Item.Value.InstanceCount",
                            "InstanceType.$": "$$.Map.Item.Value.InstanceType",
                            "VolumeSizeInGB.$": "$$.Map.Item.Value.VolumeSizeInGB",
                            "Bucket.$": "$$.Map.Item.Value.Bucket",
                            "InputPrefix.$": "$$.Map.Item.Value.InputPrefix",
                            "OutputPrefix.$": "$$.Map.Item.Value.OutputPrefix",
                            "Hyperparameters.$": "$$.Map.Item.Value.Hyperparameters",
                            "MaxRuntimeInSeconds.$": "$$.Map.Item.Value.MaxRuntimeInSeconds",
                            "ExecutionName.$": "$$.Execution.Name",
                            "Script.$": "$$.Map.Item.Value.Script",
                            "ScriptArguments.$": "$$.Map.Item.Value.ScriptArguments",
                            "MetricDefinitions.$": "$$.Map.Item.Value.MetricDefinitions"
                        },
                        "Iterator": {
                            "StartAt": "training job",
                            "States": {
                                "training job": {
                                    "Type": "Task",
                                    "Resource": "arn:aws:states:::sagemaker:createTrainingJob.sync",
                                    "Parameters": {
                                        "AlgorithmSpecification": {
                                            "TrainingImage.$": "States.Format('{}.dkr.ecr.{}.amazonaws.com/{}', $.AccountId, $.Region, $.Image)",
                                            "TrainingInputMode": "File",
                                            "MetricDefinitions.$": "$.MetricDefinitions"
                                        },
                                        "CheckpointConfig": {
                                            "LocalPath": "/opt/ml/checkpoints/",
                                            "S3Uri.$": "States.Format('s3://{}/{}/', $.Bucket, $.ExperimentName)"
                                        },
                                        "HyperParameters.$": "$.Hyperparameters",
                                        "InputDataConfig": [
                                            {
                                                "ChannelName": "training",
                                                "DataSource": {
                                                    "S3DataSource": {
                                                        "S3DataDistributionType": "FullyReplicated",
                                                        "S3DataType": "S3Prefix",
                                                        "S3Uri.$": "States.Format('s3://{}/{}', $.Bucket, $.InputPrefix)"
                                                    }
                                                },
                                                "InputMode": "File"
                                            },
                                        ],
                                        "OutputDataConfig": {
                                            "S3OutputPath.$": "States.Format('s3://{}/{}', $.Bucket, $.OutputPrefix)"
                                        },
                                        "ResourceConfig": {
                                            "InstanceCount.$": "$.InstanceCount",
                                            "InstanceType.$": "$.InstanceType",
                                            "VolumeSizeInGB.$": "$.VolumeSizeInGB"
                                        },
                                        "RetryStrategy": {
                                            "MaximumRetryAttempts": 1
                                        },
                                        "RoleArn.$": "$.RoleArn",
                                        "StoppingCondition": {
                                            "MaxRuntimeInSeconds.$": "$.MaxRuntimeInSeconds",
                                        },
                                        "TrainingJobName.$": "States.Format('{}-{}-{}', $.ExecutionName, $.ExperimentId, $.ExperimentName)",
                                    },
                                    "End": True
                                }
                            }
                        },
                        "End": True,
                    },
                }
            },
            "ResultSelector": {
                "Status": "OK"
            },
            "ResultPath": "$.TrainingExecution",
            "Next": "skip test?"
        },
        "start test": {
            "Type": "Pass",
            "Next": "skip deployment?"
        },
        "start deployment": {
            "Type": "Pass",
            "Next": "success"
        },
        "success": {
            "Type": "Succeed"
        }
    }
}


t = Template()
t.set_version("2010-09-09")
t.set_transform('AWS::Serverless-2016-10-31')

pipelinerole = t.add_resource(
    Role(
        "PipelineRole",
        AssumeRolePolicyDocument={
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": "sts:AssumeRole",
                    "Principal": {"Service": ["states.amazonaws.com"]},
                    "Effect": "Allow",
                },
            ],
        },
        Path="/",
        Policies=[
            Policy(
                PolicyName="PipelinePolicy",
                PolicyDocument={
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "sagemaker:*",
                                "events:PutTargets",
                                "events:PutRule",
                                "events:DescribeRule",
                                "iam:PassRole"
                            ],
                            "Resource": ["*"],
                            "Effect": "Allow",
                            "Sid": "AllowRun",
                        },
                        {
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": ["*"],
                            "Effect": "Allow",
                            "Sid": "AllowLogs",
                        },
                    ],
                },
            )
        ]
    )
)

sagemakerexecutionrole = t.add_resource(
    Role(
        "SageMakerExecutionRole",
        AssumeRolePolicyDocument={
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": "sts:AssumeRole",
                    "Principal": {"Service": ["sagemaker.amazonaws.com"]},
                    "Effect": "Allow",
                },
            ],
        },
        Path="/",
        ManagedPolicyArns=[
            "arn:aws:iam::aws:policy/AmazonSageMakerFullAccess",  # NOQA
        ],
        Policies=[
            Policy(
                PolicyName="PipelinePolicy",
                PolicyDocument={
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "s3:GetObject",
                                "s3:PutObject",
                                "s3:DeleteObject",
                                "s3:ListBucket",
                                "log:*"
                            ],
                            "Resource": ["*"],
                            "Effect": "Allow",
                            "Sid": "AllowS3AndLogs",
                        },
                    ],
                },
            )
        ],
    )
)

pipeline = t.add_resource(
    StateMachine(
        'Pipeline',
        StateMachineName='malware-classification-pipeline',
        StateMachineType='STANDARD',
        RoleArn=GetAtt(pipelinerole, "Arn"),
        DefinitionString=json.dumps(workflowdefinition),
        DefinitionSubstitutions={
            "AccountId": Ref("AWS::AccountId"),
            "Region": Ref("AWS::Region"),
            "RoleArn": GetAtt(sagemakerexecutionrole, "Arn")
        }
    )
)

with open('pipeline.yml', 'w') as f:
    f.write(t.to_yaml())
